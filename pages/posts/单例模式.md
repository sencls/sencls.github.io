---
title: C++ å•ä¾‹æ¨¡å¼
date: 2026-02-12
updated: 2026-02-12
categories: C++
tags:
  - C++
  - è®¾è®¡æ¨¡å¼
  - å•ä¾‹
  - å¤šçº¿ç¨‹
---

# å•ä¾‹æ¨¡å¼

> æœ¬æ–‡ä»¶æ•´ç†äº† `singleton_pattern.cpp` ä¸­çš„æ³¨é‡Šå†…å®¹

---

## æ¦‚å¿µ

**å•ä¾‹æ¨¡å¼**ï¼ˆSingleton Patternï¼‰æ˜¯åˆ›å»ºå‹è®¾è®¡æ¨¡å¼ï¼Œç¡®ä¿ä¸€ä¸ªç±»åœ¨æ•´ä¸ªç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸä¸­æœ‰ä¸”åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªå…¨å±€è®¿é—®ç‚¹æ¥è·å–è¯¥å®ä¾‹ã€‚

---

## ä½œç”¨

| ä½œç”¨ | è¯´æ˜ |
|:---|:---|
| **æ§åˆ¶å®ä¾‹æ•°é‡** | ç¡®ä¿åªæœ‰ä¸€ä¸ªï¼Œé˜²æ­¢åˆ›å»ºå¤šä¸ªè€Œå¯¼è‡´çš„èµ„æºæµªè´¹æˆ–çŠ¶æ€ä¸ä¸€è‡´ï¼Œä¾‹å¦‚ï¼šæ•°æ®åº“è¿æ¥æ± ã€é…ç½®ç®¡ç†ç±»ç­‰ |
| **æä¾›å…¨å±€è®¿é—®ç‚¹** | ä½¿å¾—ç¨‹åºåœ¨ä»»ä½•ä½ç½®éƒ½å¯ä»¥æ–¹ä¾¿çš„è®¿é—®å®ä¾‹ï¼Œå¯¹äºéœ€è¦åœ¨å¤šæ¨¡å—æˆ–ç»„ä»¶ä¹‹é—´å…±äº«çš„èµ„æºæˆ–æœåŠ¡å°¤ä¸ºé‡è¦ |
| **å»¶è¿Ÿå®ä¾‹åŒ–** | é€šå¸¸é‡‡ç”¨æ‡’åŠ è½½æ¨¡å¼ï¼Œå³ç¬¬ä¸€æ¬¡éœ€è¦æ‰åˆ›å»ºï¼Œæœ‰åŠ©äºèŠ‚çœç³»ç»Ÿèµ„æºï¼Œç‰¹åˆ«æ˜¯åœ¨å®ä¾‹åˆ›å»ºæˆæœ¬è¾ƒé«˜æˆ–åˆæœŸå¹¶ä¸éœ€è¦è¯¥å®ä¾‹çš„æƒ…å†µä¸‹ |
| **é¿å…å‘½åå†²çª** | é€šè¿‡å•ä¾‹å®ä¾‹ä½œä¸ºä¸€ä¸ªç±»çš„é™æ€æˆå‘˜ï¼Œé¿å…åœ¨å…¨å±€å‘½åç©ºé—´ä¸­å¼•å…¥å¤šä¸ªå®ä¾‹ï¼Œå‡å°‘å‘½åå†²çªçš„é£é™© |
| **ç®¡ç†å…±äº«èµ„æº** | åœ¨å¤šçº¿ç¨‹æ¨¡å¼ä¸‹ï¼Œå•ä¾‹å¯ä»¥æœ‰æ•ˆç®¡ç†å…±äº«èµ„æºï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨ |

---

## ä½¿ç”¨åœºæ™¯

### é€‚ç”¨åœºæ™¯

1. **éœ€è¦ç¡®ä¿å…¨å±€åªæœ‰ä¸€ä¸ªå®ä¾‹**
   - é…ç½®ç®¡ç†
   - æ—¥å¿—ç³»ç»Ÿ
   - è®¾å¤‡é©±åŠ¨

2. **éœ€è¦å…¨å±€è®¿é—®ç‚¹æ¥åè°ƒç³»ç»Ÿä¸­çš„å¤šä¸ªéƒ¨åˆ†**
   - ç¼“å­˜
   - çº¿ç¨‹æ± 

---

## å®ç°æ–¹å¼

### æ–¹å¼1ï¼šå±€éƒ¨é™æ€å˜é‡æ–¹å¼ï¼ˆæ¨èï¼‰

#### ç‰¹ç‚¹

- C++98 æ—¶å­˜åœ¨éšæ‚£ï¼ˆå¤šçº¿ç¨‹æ—¶å¯èƒ½ç”Ÿæˆå¤šä¸ªï¼‰
- C++11 ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œé¿å…äº†éšæ‚£ï¼ˆé™æ€æˆå‘˜å¤šæ¬¡è°ƒç”¨åªä¼šåˆ›å»ºä¸€æ¬¡ï¼‰
- æœ€ç®€æ´ã€æœ€å®‰å…¨çš„å®ç°æ–¹å¼

#### ä»£ç 

```cpp
class Single2 {
private:
    Single2() {}
    Single2(const Single2 &) = delete;
    Single2 &operator=(const Single2 &) = delete;

public:
    static Single2 &GetInst() {
        static Single2 single;  // ç¬¬ä¸€æ¬¡è°ƒç”¨ç”Ÿæˆå¯¹è±¡ï¼Œåç»­è°ƒç”¨å…±ç”¨
        return single;
    }

    ~Single2() {
        std::cout << "destory\n";
    }
};

// ä½¿ç”¨
auto &instance = Single2::GetInst();
```

#### ä¼˜ç‚¹

- âœ… çº¿ç¨‹å®‰å…¨ï¼ˆC++11 åŠä»¥ä¸Šï¼‰
- âœ… è‡ªåŠ¨é”€æ¯
- âœ… æ‡’åŠ è½½
- âœ… ä»£ç ç®€æ´

---

### æ–¹å¼2ï¼šæŒ‡é’ˆæ–¹å¼ï¼ˆé¥¿æ±‰å¼ï¼‰

#### ç‰¹ç‚¹

- ç¨‹åºå¼€å§‹æ—¶å°±åˆ›å»ºå•ä¾‹
- éœ€è¦åœ¨å¯¹åº”çš„ .cpp æ–‡ä»¶ä¸­æˆ– main() å‡½æ•°ä¸­åˆå§‹åŒ–

#### ä»£ç 

```cpp
class Single2Hungry {
private:
    Single2Hungry() {}
    Single2Hungry(const Single2Hungry &) = delete;
    Single2Hungry &operator=(const Single2Hungry &) = delete;
    static Single2Hungry *single;

public:
    static Single2Hungry* GetInst() {
        if (single == nullptr) {
            single = new Single2Hungry();
        }
        return single;
    }

    ~Single2Hungry() {
        std::cout << "destory\n";
    }
};

// åœ¨ .cpp æ–‡ä»¶ä¸­åˆå§‹åŒ–
Single2Hungry* Single2Hungry::single = Single2Hungry::GetInst();
```

#### ç¼ºç‚¹

- âŒ ææ„å­˜åœ¨é—®é¢˜ï¼ˆå†…å­˜æ³„æ¼ï¼‰
- âŒ ä¸æ˜¯æ‡’åŠ è½½
- âŒ åˆå§‹åŒ–é¡ºåºä¸ç¡®å®š

---

### æ–¹å¼3ï¼šæŒ‡é’ˆæ–¹å¼ï¼ˆæ‡’æ±‰å¼ï¼‰+ é”

#### ç‰¹ç‚¹

- è°ƒç”¨æ—¶æ‰åˆ›å»º
- ä½¿ç”¨äº’æ–¥é”ä¿è¯çº¿ç¨‹å®‰å…¨
- å­˜åœ¨æ€§èƒ½é—®é¢˜ï¼ˆæ¯æ¬¡è°ƒç”¨éƒ½éœ€è¦åŠ é”ï¼‰

#### ä»£ç 

```cpp
#include <mutex>

class Single2Lazy {
private:
    Single2Lazy() {}
    Single2Lazy(const Single2Lazy &) = delete;
    Single2Lazy &operator=(const Single2Lazy &) = delete;
    static Single2Lazy *single;
    static std::mutex _mtx;

public:
    static Single2Lazy *GetInst() {
        std::lock_guard<std::mutex> lock(_mtx);  // å­˜åœ¨ä¸²è¡Œçš„å¯èƒ½
        if (single == nullptr) {
            single = new Single2Lazy();
        }
        return single;
    }

    ~Single2Lazy() {
        std::cout << "destory\n";
    }
};

// åœ¨ .cpp æ–‡ä»¶ä¸­åˆå§‹åŒ–
Single2Lazy *Single2Lazy::single = nullptr;
std::mutex Single2Lazy::_mtx;
```

#### ç¼ºç‚¹

- âŒ æ€§èƒ½å·®ï¼ˆæ¯æ¬¡è°ƒç”¨éƒ½åŠ é”ï¼‰
- âŒ å­˜åœ¨ä¸²è¡Œçš„å¯èƒ½

---

### æ–¹å¼4ï¼šåŒé‡æ£€æŸ¥é”å®šï¼ˆDCLPï¼‰

#### ç‰¹ç‚¹

- å‡å°‘é”çš„ç«äº‰
- ç¬¬ä¸€æ¬¡æ£€æŸ¥æ—¶ä¸åŠ é”
- ä»ç„¶å­˜åœ¨çº¿ç¨‹ä¸å®‰å…¨é—®é¢˜

#### ä»£ç 

```cpp
static Single2Lazy *GetInst() {
    if (single != nullptr) {  // ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼Œä¸åŠ é”
        return single;
    }
    _mtx.lock();
    if (single != nullptr) {  // ç¬¬äºŒæ¬¡æ£€æŸ¥ï¼ŒåŠ é”å
        _mtx.unlock();
        single = new Single2Lazy();
    }
    single = new Single2Lazy();
    _mtx.unlock();
    return single;
}
```

#### ç¼ºç‚¹

- âŒ **ä»ç„¶å­˜åœ¨çº¿ç¨‹ä¸å®‰å…¨é—®é¢˜**
  - å› ä¸º `new` çš„å…³ç³»ï¼Œåœ¨å¤šçº¿ç¨‹æ—¶å¯èƒ½å–åˆ°å¼€è¾Ÿäº†åœ°å€ä½†æ²¡æœ‰æ„é€ çš„ç»“æœ
  - å¯¼è‡´æ•°æ®æ··ä¹±æˆ–è€…ç›´æ¥å´©æºƒ

---

### æ–¹å¼5ï¼šC++11 once_flagï¼ˆæ¨èï¼‰

#### ç‰¹ç‚¹

- ä½¿ç”¨ `std::call_once` ä¿è¯çº¿ç¨‹å®‰å…¨
- ä½¿ç”¨ `std::shared_ptr` ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
- æœ€ä¼˜é›…çš„å¤šçº¿ç¨‹å•ä¾‹å®ç°ä¹‹ä¸€

#### ä»£ç 

```cpp
#include <mutex>
#include <memory>

class singleOnceFlag {
private:
    singleOnceFlag() {}
    static std::shared_ptr<singleOnceFlag> _instance;

public:
    ~singleOnceFlag() {
        std::cout << "desorty\n";
    }
    singleOnceFlag &operator=(const singleOnceFlag &) = delete;
    singleOnceFlag(const singleOnceFlag &) = delete;

    static std::shared_ptr<singleOnceFlag> GetInst() {
        static std::once_flag flag;
        std::call_once(flag, []() {
            _instance = std::shared_ptr<singleOnceFlag>(new singleOnceFlag());
        });
        return _instance;
        // ä¸ºä»€ä¹ˆä¸ç”¨ make_shared() -> è¦è°ƒç”¨æ„é€ å‡½æ•°ï¼Œä½†æ˜¯ç§æœ‰æ— æ³•ä½¿ç”¨
    }
};

// åœ¨ .cpp æ–‡ä»¶ä¸­åˆå§‹åŒ–
// æ³¨æ„é™æ€æˆå‘˜çš„ç±»å¤–åˆå§‹åŒ–ï¼Œé“¾æ¥æ—¶å¯èƒ½å‡ºé”™
std::shared_ptr<singleOnceFlag> singleOnceFlag::_instance = nullptr;
```

#### ä¼˜ç‚¹

- âœ… çº¿ç¨‹å®‰å…¨
- âœ… æ‡’åŠ è½½
- âœ… ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆç®¡ç†å†…å­˜
- âœ… ä¼˜é›…çš„ C++11 é£æ ¼

#### ä¸ºä»€ä¹ˆä¸ç”¨ make_sharedï¼Ÿ

```cpp
// ä¸èƒ½ä½¿ç”¨ make_shared çš„åŸå› 
// _instance = std::make_shared<singleOnceFlag>();  // é”™è¯¯ï¼

// åŸå› ï¼š
// make_shared éœ€è¦è°ƒç”¨æ„é€ å‡½æ•°
// ä½†æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„
// make_shared ä¸æ˜¯å‹å…ƒå‡½æ•°ï¼Œæ— æ³•è®¿é—®ç§æœ‰æ„é€ å‡½æ•°
```

---

## CRTP å•ä¾‹æ¨¡æ¿

### æ¦‚å¿µ

**CRTP**ï¼ˆCuriously Recurring Template Patternï¼Œå¥‡å¼‚é€’å½’æ¨¡æ¿æ¨¡å¼ï¼‰

å°†æ´¾ç”Ÿç±»ä½œä¸ºæ¨¡æ¿å‚æ•°ä¼ é€’ç»™åŸºç±»ï¼Œå³ä¸€ä¸ªç±»ç»§æ‰¿è‡ªä¸€ä¸ªä»¥è‡ªèº«ä¸ºæ¨¡æ¿å‚æ•°çš„åŸºç±»ã€‚

### å¸¸ç”¨åœºæ™¯

- é™æ€å¤šæ€
- æ¥å£çš„é»˜è®¤å®ç°
- ç¼–è¯‘æ—¶ç­–ç•¥é€‰æ‹©
- **å•ä¾‹æ¨¡æ¿åŸºç±»**

### åŸºæœ¬ç»“æ„

```cpp
template<typename T>
class Singleton {
protected:
    Singleton() {}
    Singleton(const Singleton &) = delete;
    Singleton &operator=(const Singleton &) = delete;

public:
    static T &GetInst() {
        static T instance;
        return instance;
    }
};

// ä½¿ç”¨ CRTP
class RealClass : public Singleton<RealClass> {
    // RealClass çš„æ„é€ å‡½æ•°éœ€è¦æ˜¯ protected æˆ– public
    // å› ä¸º Singleton<RealClass> éœ€è¦è°ƒç”¨å®ƒ
protected:
    RealClass() {}

public:
    void doSomething() {
        std::cout << "RealClass doing something" << std::endl;
    }
};

// ä½¿ç”¨
auto &instance = RealClass::GetInst();
instance.doSomething();
```

### å®Œæ•´ç¤ºä¾‹

```cpp
template<typename T>
class SingletonBase {
protected:
    SingletonBase() = default;
    SingletonBase(const SingletonBase &) = delete;
    SingletonBase &operator=(const SingletonBase &) = delete;

public:
    static T &GetInstance() {
        static T instance;
        return instance;
    }
};

class MySingleton : public SingletonBase<MySingleton> {
    friend class SingletonBase<MySingleton>;

private:
    MySingleton() {
        std::cout << "MySingleton constructed" << std::endl;
    }

public:
    void DoWork() {
        std::cout << "Working..." << std::endl;
    }
};

// ä½¿ç”¨
int main() {
    MySingleton &singleton = MySingleton::GetInstance();
    singleton.DoWork();
    return 0;
}
```

---

## å‹å…ƒç±»ä¸ç§æœ‰ææ„

### æç«¯å•ä¾‹å®ç°

é€šè¿‡ä½¿ç”¨å‹å…ƒç±»æ¥è°ƒç”¨ç§æœ‰çš„ææ„å‡½æ•°ï¼Œå®ç°æ›´æç«¯çš„å•ä¾‹ã€‚

```cpp
class Singleton {
private:
    Singleton() {}
    ~Singleton() {
        std::cout << "Singleton destroyed" << std::endl;
    }
    Singleton(const Singleton &) = delete;
    Singleton &operator=(const Singleton &) = delete;

    // å£°æ˜å‹å…ƒç±»
    friend class SingletonDeleter;

public:
    static Singleton &GetInst() {
        static Singleton instance;
        return instance;
    }
};

// ä¸“é—¨ç”¨äºåˆ é™¤å•ä¾‹çš„å‹å…ƒç±»
class SingletonDeleter {
public:
    void Destroy() {
        // å¯ä»¥è®¿é—® Singleton çš„ç§æœ‰ææ„å‡½æ•°
    }
};
```

---

## å¤šçº¿ç¨‹æµ‹è¯•

### æµ‹è¯•ä»£ç 

```cpp
#include <iostream>
#include <thread>

int main() {
    std::cout << SingleNet::GetInst() << std::endl;

    std::thread t1([]() {
        std::cout << SingleNet::GetInst() << std::endl;
    });

    std::thread t2([]() {
        std::cout << SingleNet::GetInst() << std::endl;
    });

    t1.join();
    t2.join();

    return 0;
}
```

---

## æ€»ç»“

### å®ç°æ–¹å¼å¯¹æ¯”

| æ–¹å¼ | çº¿ç¨‹å®‰å…¨ | æ‡’åŠ è½½ | å†…å­˜å®‰å…¨ | æ¨èåº¦ |
|:---|:---:|:---:|:---:|:---:|
| **å±€éƒ¨é™æ€å˜é‡** | âœ… C++11+ | âœ… | âœ… | â­â­â­â­â­ |
| **é¥¿æ±‰å¼ï¼ˆæŒ‡é’ˆï¼‰** | âœ… | âŒ | âŒ | â­â­ |
| **æ‡’æ±‰å¼ï¼ˆé”ï¼‰** | âœ… | âœ… | âœ… | â­â­â­ |
| **åŒé‡æ£€æŸ¥é”å®š** | âŒ | âœ… | âŒ | âŒ |
| **once_flag** | âœ… | âœ… | âœ… | â­â­â­â­ |
| **CRTP æ¨¡æ¿** | âœ… C++11+ | âœ… | âœ… | â­â­â­â­â­ |

### æ¨èå®ç°

#### ç®€å•åœºæ™¯

```cpp
class Singleton {
private:
    Singleton() = default;
    Singleton(const Singleton &) = delete;
    Singleton &operator=(const Singleton &) = delete;

public:
    static Singleton &GetInst() {
        static Singleton instance;
        return instance;
    }
};
```

#### å¤æ‚åœºæ™¯ï¼ˆéœ€è¦æ§åˆ¶ææ„æ—¶æœºï¼‰

```cpp
class Singleton {
private:
    Singleton() = default;
    Singleton(const Singleton &) = delete;
    Singleton &operator=(const Singleton &) = delete;

public:
    static std::shared_ptr<Singleton> GetInst() {
        static std::once_flag flag;
        static std::shared_ptr<Singleton> instance;
        std::call_once(flag, []() {
            instance = std::shared_ptr<Singleton>(new Singleton());
        });
        return instance;
    }
};
```

---

> æ•´ç†è€…ï¼šè•¾å§† ğŸ’™
